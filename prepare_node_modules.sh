#!/bin/bash

TARGET=$(head -n 1 target_os)
VERSION=`node -p -e "require('./server/package-lock.json').dependencies['ffi-napi'].version"`
rm -rf server/node_modules client/node_modules
mv package.json package1.json
mv package-lock.json package-lock1.json
mv node_modules node_modules1
mv server/package.json server/package1.json
mv server/package-lock.json server/package-lock1.json

cd server
# https://github.com/npm/rfcs/pull/364
npm install --no-package-lock --no-save ffi-napi@${VERSION}
cd ..

echo "TARGET=${TARGET}"
if [[ "${TARGET}" == "darwin-arm64" ]]; then
    tar -xvf darwin-arm64.tgz -C server/node_modules/
fi
mv package1.json package.json
mv package-lock1.json package-lock.json
mv node_modules1 node_modules
mv server/package1.json server/package.json
mv server/package-lock1.json server/package-lock.json
